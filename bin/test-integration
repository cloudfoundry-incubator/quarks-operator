#!/bin/bash
set -eu

GIT_ROOT="${GIT_ROOT:-$(git rev-parse --show-toplevel)}"
. "${GIT_ROOT}/bin/include/versioning"
. "${GIT_ROOT}/bin/include/docker"
. "${GIT_ROOT}/bin/include/testing"
. "${GIT_ROOT}/bin/include/dependencies"

name="${1-}"

if [ -z ${TEST_NAMESPACE+x} ]; then
  TEST_NAMESPACE="test$(date +%s)"
  export TEST_NAMESPACE
fi

: "${CF_OPERATOR_TESTING_TMP:=/tmp}"
echo "Test logs are here: ${CF_OPERATOR_TESTING_TMP}/cf-operator-tests-*.log"
setup_testing_tmp
trap cleanup_testing_tmp EXIT

# Run code coverage only in CI
COV_ARG=""
if [ ${COVERAGE+x} ]; then
  pkgs="code.cloudfoundry.org/quarks-operator/pkg/bosh/...,\
    code.cloudfoundry.org/quarks-operator/pkg/credsgen/...,\
    code.cloudfoundry.org/quarks-operator/pkg/kube/controllers/...,\
    code.cloudfoundry.org/quarks-operator/pkg/kube/operator/...,\
    code.cloudfoundry.org/quarks-operator/pkg/kube/util/...,\
    code.cloudfoundry.org/quarks-operator/pkg/kube/config/..."
  pkgs=${pkgs// /}
  COV_ARG="-cover -outputdir=./code-coverage -coverprofile=integration$name.coverprofile -coverpkg $pkgs"
  mkdir -p code-coverage
fi

NODES=${NODES:-3}
FLAKE_ATTEMPTS=${FLAKE_ATTEMPTS:-3}
ginkgo ${FOCUS:+ --focus "$FOCUS"} \
  --randomizeAllSpecs \
  --nodes="$NODES" \
  --slowSpecThreshold=50 \
  --flakeAttempts="$FLAKE_ATTEMPTS" \
  $COV_ARG \
  integration/"$name"
